# Task Scheduler in Linux


หากเราเบื่อที่จะต้องมารันคำสั่งด้วยตนเองเป็นประจำๆทุกๆครั้ง เราสามารใช้ task scheduler ใน linux เพื่อช่วยเรากำจัดปัญหาแบบนี้ไปได้ ตัวของ task scheduler จะทำหน้าที่เหมือนับตัวตั้งเวลา เราสามารถที่จะตั้งเวลาเพื่อบอกให้ OS (Operating System) รันคำสั่งต่างๆที่เราต้องการได้เมื่อถึงเวลานั้นๆ


โดยเราสามารถใช้ task scheduler ใน linux โดยใช้คำสั่งทั้ง 2 คำสั่งก็คือ **Cron** หรือไม่ก็ **At** โดยเป็นคำสั่งที่ใช้เพื่อทำให้สามารถรันคำสั่งได้เองเมื่อถึงเวลา

## Cron

Cron เป็นเหมือนกับเครื่องมือ ที่จะช่วยทำให้ระบบนั้นสามารถรันคำสั่งได้ เมื่อถึงเวลาที่กำหนดเอาไว้โดยจะไปดูงานใน crontab file โดยมันจะทำงานในตอนที่ระบบบูทตัวเองขึ้นมาจาก /etc/init.d หรือ /etc/rc.d/init/d scripts.

### Crontab

Crontab จะทำหน้าที่เป็น script ที่เก็บคำสั่งต่างๆที่จะรันเอาไว้ โดยคำสั่งต่างๆใน Crontab จะถูกเรียกว่า **Cronjobs**


-----------------------------------------

### Example of Crontab command :

เราสามารถที่จะดู แก้ไข หรือ ลบ คำสั่งใน crontab ได้โดยใช้คำสั่งเหล่านี้
   ```bash
   crontab -l ## ดูรายการ cronjob ต่างๆ
   crontab -e ## เพื่อแก้ไขหรือเพิ่ม cronjob
   crontab -r ## เพื่อลบ cronjob ออก
   ```

##### crontab -e
เมื่อเรารันคำสั่งนี้เราจะเห็นหน้าต่างลักษณะดังภาพ ในหน้าต่างนี้เราสามารถที่จะแก้ไข เพิ่มหรือลบ job บางอย่างออกได้


![atq command](/cron%20command%20-e.png)

##### crontab -l
เมื่อเรารันคำสั่งนี้เราจะได้ผลลัพธ์ที่ดูจะมีความคล้ายคลึงกับคำสั่ง **crontab -e** แต่ในหน้านี้เราจะไม่สามารถแก้ไขหรือเพิ่มอะไรได้ จะทำได้แค่ดูรายการคำสั่งเท่านั้น


![atq command](/cron%20command%20-l.png)

##### crontab -r
เราสามารถที่จะลบ cronjob ทั้งหมดออกได้เลยทีเดียวเพียงแค่ใช้คำสั่งนี้

![atq command](/cron%20command%20-r.png)

### Cronjob syntax
หน้าตา syntax ของคำสั่งจะมีลักษณะดังนี้ 

   ```bash
   * * * * * 'คำสั่งที่ต้องการรันหรือ path ไปหาคำสั่งของเรา'
   --------------------------------------------------
   | | | | | ==> ## วันต่างๆในสัปดาห์ (0-7)
   | | | | ==> ## เดือน (1-12)
   | | | ==> ## วันในเดือนต่างๆ (1-31)
   | | ==> ## ชั่วโมง (0-23)
   | ==> ## นาที (0-59)
   ```
เรายังสามารถใช้ Shortcuts แทนการเขียนระบุเวลาแบบเต็มๆได้

   | Shortcut | Descriptions | 
   |----------|-------------|
   @reboot | ให้รันคำสั่งทุกๆครั้งที่เครื่องทำการ reboot
   @hourly | ให้รันคำสั่งทุกๆชั่วโมง '0 * * * *'.
   @daily  | ให้รันคำสั่งทุกๆวัน '0 0 * * *'
   @midnight | ให้รันคำสั่งทุกๆเที่ยงคืนมีค่าเหมือนกับ @daily '0 0 * * *'
   @weekly | run command weekly '0 0 * * 0'
   @monthly | run command monthly '0 0 1 * *'
   @yearly | run command yearly '0 0 1 1 *'
   @annually | run command yearly '0 0 1 1 *'

ข้อมูลเพิ่มเติม

--------------------------------
## At
**at** เป็นคำสั่งที่มีความคล้ายคลึงกันกับคำสั่ง **cron** แต่การใช้คำสั่ง **cron** นั้นจะใช้เพื่อรันคำสั่งซ้ำๆทุกครั้งที่เวลามาถึง จะต่างจากการใช้คำสั่ง **at** ที่เมื่อถึงเวลาแล้วจะรันคำสั่งนั้นเพียงครั้งเดียว


แต่ก่อนที่เราจะใช้คำสั่ง **at** เราจำเป็นต้องเช็คก่อนว่าที่เครื่องของเรามีการติดตั้งคำสั่งนี้ไปเป็นที่เรียบร้อย ถ้ายังไม่ได้ทำการติดตั้งเราสามารถติดตั้งได้โดยใช้คำสั่ง

   ```bash
   ## ติดตั้งคำสั่ง at ลงในเครื่อง
   sudo apt-get update
   sudo apt-get install at
   ```
### At syntax & usage 
ขั้นแรกเราจะต้องเข้าไปหน้า prompt ของคำสั่ง **at** ก่อนเพื่อจะทำการเพิ่มคำสั่งต่างๆลงไปใน list ซึ่งหากเราต้องการออกจากหน้า prompt เราสามารถออกได้โดยกด **Ctrl+D** หรือเราสามารถเพิ่มคำสั่งไปได้เลยโดยตรงโดยไม่ต้องเข้า prompt โดยการใช้ตัว **|** หรือตัวไปป์

   ```bash
   ## การใช้งานคำสั่ง at
   at (เวลาที่ต้องการให้คำสั่งรัน) ## เพื่อเข้าหน้า prompt
   คำสั่งที่เราต้องการรัน #พิมพ์คำสั่งที่ต้องการ

   ## หรือ
   echo 'path ไปหา script คำสั่ง' | at (เวลา)
   ```
เราไม่จำเป็นต้องพิมพ์เวลาตามรูปแบบนาฬิกา เราสามารถใช้ format อื่นๆเพื่อเขียนในคำสั่ง **at** ได้
### Example
   ```bash
   at 3pm ## ให้รันตอนบ่าย 3 โมง
   at Tuesday ## ให้รันตอนวันอังคาร
   at Tuesday + 10 minutes ## ให้รันในอีก 10 นาทีของวันอังคาร
   at now ## ให้รันตอนนี้เดี๋ยวนี้
   ```
### Time format
| Time | Descriptions | 
   |----------|-------------|
   midnight | ให้รันเมื่อถึงเวลาเที่ยงคืน
   teatime | ให้รันเมื่อถึงเวลา 4 โมง
   now | ให้รันตอนนี้
   YYMMDDhhmmss | ให้รันในช่วงเวลาที่กำหนด (ปี, เดือน, วัน, ชั่วโมง, นาที, วินาที)
  CCYYMMDDhhmmss | ให้รันในช่วงเวลาที่กำหนด (ปี, เดือน, วัน, ชั่วโมง, นาที, วินาที)

### View at command and remove
เราสามารถดู list คำสั่งต่างของ **at** หรือลบแแกได้โดยใช้คำสั่งเหล่านี้
   ```bash
   ## ดู List คำสั่ง at
   at -l
   atq
   ## ลบคำสั่ง at ที่ต้องการออก
   at -r (เลขประจำ job)
   ``` 
### Example
ตัวอย่างการใช้คำสั่ง **atq** และ **at -r**

![atq command](/atq%20command.png) ![at -r command](/at%20-r%20command.png)

เราสามารถดู list คำสั่งต่างๆที่รอรันได้จากการใช้งานคำสั่ง **atq** และเราสามารถลบคำสั่งที่ต้องการได้ โดยต้องระบุหมายเลขประจำของคำสั่งนั้นๆที่ต้องการลบ โดยหมายเลขจะอยู่ทางด้านซ้ายของคำสั่ง

### At command arguments
เราสามารถเพิ่ม arguments หรือ options ต่างๆเพื่อใช้คำสั่ง at ทำบางอย่างเพิ่มเติมได้
นี้คือตัวอย่างของการใช้ arguments บางอย่าง

| Time | Descriptions | Example command|
   |----------|-------------|------------|
   |-d         | ลบคำสั่ง | **at -d 2** |
   | -f        | ไฟล์ที่ต้องการให้รัน| **at -f eiei.sh Monday** |
   | -l        | โชว์คำสั่ง **at** ทั้งหมด | **at -l** |
   | -c        | ดูเฉพาะคำสั่ง **at** ที่ต้องการ | **at -c 2**|

---------------------------------

### References:
##### cron
- https://linuxhint.com/schedule_linux_task/
- https://www.techtarget.com/searchdatacenter/definition/crontab
- https://pongpitta.medium.com/%E0%B8%81%E0%B8%B2%E0%B8%A3%E0%B9%83%E0%B8%8A%E0%B9%89%E0%B8%87%E0%B8%B2%E0%B8%99-crontab-%E0%B8%9A%E0%B8%99-linux-server-6272d376ecdb
##### at
- https://www.geeksforgeeks.org/at-command-in-linux-with-examples/
- https://opensource.com/article/21/8/linux-at-command

-------------------------------------------------------











